<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DUYDODEE 4K - Master Admin System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #020617; color: #e2e8f0; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        input, select, textarea { background: #0f172a !important; border: 1px solid #1e293b !important; color: white !important; }
        input:focus { border-color: #0ea5e9 !important; ring: 2px #0ea5e9; }
    </style>
</head>
<body class="custom-scrollbar min-h-screen">

    <div class="flex flex-col md:flex-row">
        <aside class="w-full md:w-64 md:h-screen sticky top-0 bg-slate-950 p-6 border-r border-slate-800">
            <div class="text-2xl font-bold text-sky-500 mb-10 flex items-center gap-2">
                <i class="fa-solid fa-screwdriver-wrench"></i> ADMIN<span class="text-white">4K</span>
            </div>
            <nav class="space-y-2">
                <a href="#" class="flex items-center gap-3 px-4 py-3 bg-sky-600 text-white rounded-xl font-bold shadow-lg shadow-sky-900/20">
                    <i class="fa-solid fa-film"></i> จัดการซีรีส์
                </a>
                <a href="/client/index.html" class="flex items-center gap-3 px-4 py-3 text-slate-400 hover:bg-slate-900 rounded-xl transition">
                    <i class="fa-solid fa-eye"></i> ดูหน้าเว็บหลัก
                </a>
            </nav>
        </aside>

        <main class="flex-1 p-4 md:p-10">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                <div class="glass p-6 rounded-2xl border-l-4 border-sky-500">
                    <p class="text-slate-500 text-xs uppercase font-bold tracking-widest">ซีรีส์ทั้งหมด</p>
                    <h3 class="text-3xl font-bold mt-1" id="statTotal">0</h3>
                </div>
                <div class="glass p-6 rounded-2xl border-l-4 border-yellow-500">
                    <p class="text-slate-500 text-xs uppercase font-bold tracking-widest">เรื่องที่เป็น VIP</p>
                    <h3 class="text-3xl font-bold mt-1" id="statVip">0</h3>
                </div>
                <div class="flex items-end">
                    <button onclick="openModal()" class="w-full bg-sky-600 hover:bg-sky-500 text-white font-bold py-4 rounded-2xl transition shadow-xl shadow-sky-900/40 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-plus"></i> เพิ่มซีรีส์ใหม่
                    </button>
                </div>
            </div>

            <div class="glass rounded-2xl overflow-hidden shadow-2xl">
                <div class="p-6 border-b border-slate-800 flex justify-between items-center">
                    <h2 class="font-bold text-lg">รายการซีรีส์ในระบบ</h2>
                    <input type="text" oninput="searchAdmin()" id="adminSearch" placeholder="ค้นหาซีรีส์..." class="px-4 py-2 rounded-lg text-sm w-64">
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-slate-900/50 text-xs text-slate-400 uppercase">
                            <tr>
                                <th class="p-4">ปก</th>
                                <th class="p-4">ชื่อเรื่อง</th>
                                <th class="p-4">หมวดหมู่</th>
                                <th class="p-4">สิทธิ์</th>
                                <th class="p-4 text-right">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="adminTableBody" class="divide-y divide-slate-800"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="movieModal" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center p-4 z-[100] animate-fade-in overflow-y-auto">
        <div class="glass w-full max-w-4xl rounded-3xl p-6 md:p-8 my-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold flex items-center gap-2" id="modalTitle">
                    <i class="fa-solid fa-circle-plus text-sky-500"></i> เพิ่มข้อมูลซีรีส์
                </h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-white text-2xl">&times;</button>
            </div>

            <div class="mb-8 p-4 bg-sky-500/10 border border-sky-500/20 rounded-2xl flex flex-col md:flex-row gap-3">
                <div class="flex-1 relative">
                    <i class="fa-brands fa-youtube absolute left-3 top-3 text-red-500"></i>
                    <input type="text" id="aiUrl" placeholder="วางลิงก์ YouTube เพื่อให้ AI ดึงข้อมูล..." class="w-full pl-10 pr-4 py-2.5 rounded-xl text-sm outline-none">
                </div>
                <button id="aiBtn" onclick="fetchAiData()" class="bg-sky-600 hover:bg-sky-500 px-6 py-2.5 rounded-xl text-sm font-bold transition flex items-center justify-center gap-2 min-w-[140px]">
                    <i class="fa-solid fa-robot"></i> <span>ดึงข้อมูล AI</span>
                </button>
            </div>

            <form id="movieForm" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <input type="hidden" id="movieId">
                
                <div class="space-y-4">
                    <div class="aspect-[2/3] rounded-2xl bg-slate-900 border-2 border-dashed border-slate-700 overflow-hidden relative group">
                        <img id="posterPreview" src="" class="w-full h-full object-cover hidden">
                        <div id="posterPlaceholder" class="absolute inset-0 flex flex-col items-center justify-center text-slate-500">
                            <i class="fa-solid fa-image text-4xl mb-2"></i>
                            <p class="text-xs text-center px-4">ใส่ลิงก์รูปเพื่อ Preview</p>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-slate-500 mb-1 block uppercase font-bold">Poster URL</label>
                        <input type="text" id="posterUrl" oninput="updatePreview()" class="w-full px-3 py-2 rounded-lg text-sm" required>
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-slate-500 mb-1 block uppercase font-bold">ชื่อเรื่อง</label>
                        <input type="text" id="title" class="w-full px-3 py-2 rounded-lg" required>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs text-slate-500 mb-1 block uppercase font-bold">ปี</label>
                            <input type="number" id="year" class="w-full px-3 py-2 rounded-lg">
                        </div>
                        <div>
                            <label class="text-xs text-slate-500 mb-1 block uppercase font-bold">เรตติ้ง</label>
                            <input type="number" step="0.1" id="rating" class="w-full px-3 py-2 rounded-lg">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-slate-500 mb-1 block uppercase font-bold">YouTube ID</label>
                        <input type="text" id="ytId" class="w-full px-3 py-2 rounded-lg font-mono text-sky-400" required>
                    </div>
                    <div>
                        <label class="text-xs text-slate-500 mb-1 block uppercase font-bold">นักแสดง</label>
                        <input type="text" id="actors" class="w-full px-3 py-2 rounded-lg">
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-slate-500 mb-1 block uppercase font-bold">หมวดหมู่</label>
                        <select id="category" class="w-full px-3 py-2 rounded-lg">
                            <option value="china">ซีรีส์จีน (China)</option>
                            <option value="inter">พากย์ไทย (Inter)</option>
                            <option value="anime">อนิเมะ (Anime)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-slate-500 mb-1 block uppercase font-bold">จำนวนตอน</label>
                        <input type="number" id="totalEpisodes" class="w-full px-3 py-2 rounded-lg">
                    </div>
                    <div>
                        <label class="text-xs text-slate-500 mb-1 block uppercase font-bold">สิทธิ์สมาชิก</label>
                        <label class="flex items-center gap-3 p-3 bg-yellow-500/5 border border-yellow-500/20 rounded-xl cursor-pointer">
                            <input type="checkbox" id="isVip" class="w-5 h-5 accent-yellow-500">
                            <span class="text-yellow-500 font-bold">VIP Only</span>
                        </label>
                    </div>
                    <div class="flex gap-2 pt-4">
                        <button type="submit" class="flex-1 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl transition shadow-lg shadow-green-900/20">บันทึก</button>
                    </div>
                </div>

                <div class="md:col-span-3">
                    <label class="text-xs text-slate-500 mb-1 block uppercase font-bold">เรื่องย่อ / ข้อคิด</label>
                    <textarea id="description" rows="3" class="w-full px-3 py-2 rounded-lg text-sm"></textarea>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000/api';
        let allMovies = [];

        // 1. โหลดข้อมูลทั้งหมด
        async function loadMovies() {
            try {
                const res = await fetch(`${API_URL}/movies`);
                const json = await res.json();
                allMovies = json.data;
                renderTable(allMovies);
                updateStats();
            } catch (err) { alert('เชื่อมต่อ Server ไม่ได้'); }
        }

        // 2. แสดงตาราง
        function renderTable(movies) {
            document.getElementById('adminTableBody').innerHTML = movies.map(m => `
                <tr class="hover:bg-slate-900 transition">
                    <td class="p-2">
                        <img src="${m.posterUrl}" alt="${m.title}" class="w-12 h-auto object-cover rounded-md" onerror="this.onerror=null; this.src='https://placehold.co/300x450?text=No+Image'">
                    </td>
                    <td class="p-4 font-bold text-sm">${m.title} <br> <span class="text-xs text-slate-500 font-normal">${m.year}</span></td>
                    <td class="p-4 text-xs font-medium uppercase text-slate-400">${m.category}</td>
                    <td class="p-4">${m.isVip ? '<span class="text-yellow-500 text-xs font-bold bg-yellow-500/10 px-2 py-1 rounded border border-yellow-500/20"><i class="fa-solid fa-crown"></i> VIP</span>' : '<span class="text-slate-500 text-xs">FREE</span>'}</td>
                    <td class="p-4 text-right">
                        <button onclick="editMovie('${m._id}')" class="text-sky-400 hover:text-white p-2 transition"><i class="fa-solid fa-pen-to-square"></i></button>
                        <button onclick="deleteMovie('${m._id}')" class="text-red-400 hover:text-white p-2 transition"><i class="fa-solid fa-trash-can"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        // 3. ฟังก์ชั่น AI จัดเต็ม
        async function fetchAiData() {
            const btn = document.getElementById('aiBtn');
            const url = document.getElementById('aiUrl').value;
            const vid = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/)?.[1] || url;
            
            if(!vid) return alert('ใส่ลิงก์ YouTube ก่อนครับ');

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> AI กำลังทำงาน...';

            try {
                const res = await fetch(`${API_URL}/fetch-movie-data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('accessToken')}` },
                    body: JSON.stringify({ videoId: vid })
                });
                const json = await res.json();
                
                if(json.success) {
                    const d = json.data;
                    document.getElementById('title').value = d.title;
                    document.getElementById('year').value = d.year;
                    document.getElementById('rating').value = d.rating;
                    document.getElementById('ytId').value = d.ytId;
                    document.getElementById('posterUrl').value = d.posterUrl;
                    document.getElementById('description').value = d.description + "\n\nนักแสดง: " + d.actors + "\nข้อคิด: " + d.lessons;
                    updatePreview();
                }
            } catch (err) { alert('AI Error'); }
            
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-robot"></i> ดึงข้อมูล AI';
        }

        // 4. บันทึกข้อมูล
        document.getElementById('movieForm').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('movieId').value;
            const data = {
                title: document.getElementById('title').value,
                year: document.getElementById('year').value,
                rating: document.getElementById('rating').value,
                ytId: document.getElementById('ytId').value,
                posterUrl: document.getElementById('posterUrl').value,
                category: document.getElementById('category').value,
                totalEpisodes: document.getElementById('totalEpisodes').value,
                description: document.getElementById('description').value,
                isVip: document.getElementById('isVip').checked
            };

            await fetch(id ? `${API_URL}/movies/${id}` : `${API_URL}/movies`, {
                method: id ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('accessToken')}` },
                body: JSON.stringify(data)
            });
            closeModal(); loadMovies();
        };

        // UI Helpers
        function openModal() { document.getElementById('movieModal').classList.remove('hidden'); document.getElementById('movieForm').reset(); document.getElementById('movieId').value = ''; updatePreview(); }
        function closeModal() { document.getElementById('movieModal').classList.add('hidden'); }
        function updatePreview() {
            const url = document.getElementById('posterUrl').value;
            const img = document.getElementById('posterPreview');
            const placeholder = document.getElementById('posterPlaceholder');
            if(url) { img.src = url; img.classList.remove('hidden'); placeholder.classList.add('hidden'); }
            else { img.classList.add('hidden'); placeholder.classList.remove('hidden'); }
        }
        function updateStats() {
            document.getElementById('statTotal').innerText = allMovies.length;
            document.getElementById('statVip').innerText = allMovies.filter(m => m.isVip).length;
        }
        function editMovie(id) {
            const m = allMovies.find(i => i._id === id);
            document.getElementById('movieId').value = m._id;
            document.getElementById('title').value = m.title;
            document.getElementById('year').value = m.year;
            document.getElementById('rating').value = m.rating;
            document.getElementById('ytId').value = m.ytId;
            document.getElementById('posterUrl').value = m.posterUrl;
            document.getElementById('category').value = m.category;
            document.getElementById('totalEpisodes').value = m.totalEpisodes;
            document.getElementById('description').value = m.description;
            document.getElementById('isVip').checked = m.isVip;
            updatePreview();
            document.getElementById('movieModal').classList.remove('hidden');
        }
        async function deleteMovie(id) { if(confirm('ต้องการลบซีรีส์เรื่องนี้จริงหรือไม่?')) { await fetch(`${API_URL}/movies/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${localStorage.getItem('accessToken')}` } }); loadMovies(); } }
        
        function searchAdmin() {
            const searchTerm = document.getElementById('adminSearch').value.toLowerCase().trim();
            const filteredMovies = allMovies.filter(movie => movie.title.toLowerCase().includes(searchTerm));
            renderTable(filteredMovies);
        }

        loadMovies();
    </script>
</body>
</html>