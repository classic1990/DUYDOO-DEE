<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DUYDODEE 4K - Master Admin System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #020617; color: #e2e8f0; overflow-x: hidden; }
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        input, select, textarea { background: #0f172a !important; border: 1px solid #1e293b !important; color: white !important; }
        input:focus { border-color: #0ea5e9 !important; ring: 2px #0ea5e9; }
        .active-nav { background: #0284c7 !important; color: white !important; box-shadow: 0 10px 15px -3px rgba(14, 165, 233, 0.2); }
        .section-animate { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #uploadLoading { display: none; background: rgba(0,0,0,0.7); }
        
        /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏£‡∏π‡∏õ‡∏õ‡∏Å‡πÅ‡∏à‡πà‡∏°‡πÜ */
        #posterPreview { transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 1.5rem; }
        .glow-sky { box-shadow: 0 0 25px rgba(14, 165, 233, 0.3); border: 2px solid #0ea5e9; }
    </style>
</head>
<body class="custom-scrollbar min-h-screen">

    <div class="flex flex-col md:flex-row">
        <aside class="w-full md:w-72 md:h-screen sticky top-0 bg-slate-950/90 p-6 border-r border-slate-800 backdrop-blur-xl z-50">
            <div class="text-2xl font-bold text-sky-500 mb-10 flex items-center gap-2">
                <i class="fa-solid fa-screwdriver-wrench text-sky-400"></i> ADMIN<span class="text-white">4K</span>
            </div>
            <nav class="space-y-2">
                <button onclick="showSection('movies')" id="nav-movies" class="active-nav w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold transition text-left">
                    <i class="fa-solid fa-film"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ã‡∏µ‡∏£‡∏µ‡∏™‡πå
                </button>
                <button onclick="showSection('users')" id="nav-users" class="w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:bg-slate-900 rounded-xl transition text-left">
                    <i class="fa-solid fa-users"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                </button>
                <button onclick="showSection('announcement')" id="nav-announcement" class="w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:bg-slate-900 rounded-xl transition text-left">
                    <i class="fa-solid fa-bullhorn"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
                </button>
                <div class="pt-6 border-t border-slate-800 mt-6 space-y-1">
                    <p class="text-[10px] font-bold text-slate-500 uppercase px-4 mb-2 tracking-widest">‡∏£‡∏∞‡∏ö‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                    <button onclick="backupDatabase()" class="w-full flex items-center gap-3 px-4 py-2 text-emerald-400 hover:bg-emerald-500/10 rounded-lg transition text-sm text-left">
                        <i class="fa-solid fa-cloud-arrow-down"></i> ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Backup)
                    </button>
                    <button onclick="document.getElementById('restoreFile').click()" class="w-full flex items-center gap-3 px-4 py-2 text-orange-400 hover:bg-orange-500/10 rounded-lg transition text-sm text-left">
                        <i class="fa-solid fa-cloud-arrow-up"></i> ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Restore)
                    </button>
                    <input type="file" id="restoreFile" class="hidden" accept=".json">
                </div>
                <div class="pt-6 space-y-1">
                    <a href="index.html" class="flex items-center gap-3 px-4 py-2 text-slate-400 hover:text-white transition text-sm">
                        <i class="fa-solid fa-eye"></i> ‡∏î‡∏π‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏´‡∏•‡∏±‡∏Å
                    </a>
                    <button onclick="logout()" class="w-full flex items-center gap-3 px-4 py-2 text-red-400 hover:bg-red-500/10 rounded-lg transition text-sm text-left">
                        <i class="fa-solid fa-power-off"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </div>
            </nav>
        </aside>

        <main class="flex-1 p-6 md:p-10 relative">
            <div class="flex justify-between items-center mb-10">
                <div class="section-animate">
                    <h2 class="text-3xl font-bold text-white tracking-tight" id="sectionTitle">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</h2>
                    <p class="text-slate-400 text-sm">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô DUYDODEE 4K</p>
                </div>
                <div id="userProfile" class="flex items-center gap-4 glass px-5 py-2.5 rounded-2xl border border-white/10 shadow-2xl transition-all duration-500 opacity-0 transform translate-x-5">
                    <div class="text-right hidden sm:block">
                        <p id="profileName" class="text-sm font-bold text-white"></p>
                        <p id="profileRole" class="text-[10px] text-sky-400 font-bold uppercase tracking-wider"></p>
                    </div>
                    <div class="relative group">
                        <img id="profileImage" src="" class="w-11 h-11 rounded-full border-2 border-sky-500/30 object-cover cursor-pointer hover:border-sky-400 transition">
                        <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 border-2 border-slate-950 rounded-full"></div>
                    </div>
                </div>
            </div>

            <div id="moviesSection" class="section-animate">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
                    <div class="glass p-6 rounded-3xl border-l-4 border-sky-500 shadow-xl">
                        <p class="text-slate-500 text-xs font-bold uppercase tracking-widest">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                        <h3 class="text-4xl font-bold mt-1" id="statTotal">0</h3>
                    </div>
                    <div class="glass p-6 rounded-3xl border-l-4 border-yellow-500 shadow-xl">
                        <p class="text-slate-500 text-xs font-bold uppercase tracking-widest">VIP Only</p>
                        <h3 class="text-4xl font-bold mt-1" id="statVip">0</h3>
                    </div>
                    <button onclick="openAddModal()" class="bg-sky-600 hover:bg-sky-500 text-white font-bold py-4 rounded-3xl transition shadow-xl shadow-sky-900/30 flex items-center justify-center gap-3">
                        <i class="fa-solid fa-plus-circle text-xl"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
                    </button>
                    <button onclick="openBatchModal()" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-4 rounded-3xl transition shadow-xl shadow-purple-900/30 flex items-center justify-center gap-3">
                        <i class="fa-solid fa-layer-group text-xl"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°
                    </button>
                </div>

                <!-- Chart Section -->
                <div class="mb-10 glass p-6 rounded-3xl shadow-xl max-w-2xl mx-auto lg:mx-0">
                    <h3 class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-6"><i class="fa-solid fa-chart-simple text-sky-500"></i> 10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏° (View Count)</h3>
                    <div class="h-64 w-full">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>

                <div class="glass rounded-3xl overflow-hidden shadow-2xl">
                    <div class="p-6 border-b border-slate-800 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <h2 class="font-bold text-lg flex items-center gap-2"><i class="fa-solid fa-list text-sky-500"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</h2>
                        <div class="flex flex-col sm:flex-row gap-4 w-full sm:w-auto">
                            <select id="categoryFilter" onchange="filterAdmin()" class="px-4 py-2.5 rounded-2xl outline-none cursor-pointer bg-slate-900 border border-slate-800 text-slate-300 focus:border-sky-500">
                                <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                <option value="china">‡∏ã‡∏µ‡∏£‡∏µ‡∏™‡πå‡∏à‡∏µ‡∏ô</option>
                                <option value="inter">‡∏û‡∏≤‡∏Å‡∏¢‡πå‡πÑ‡∏ó‡∏¢/‡∏ù‡∏£‡∏±‡πà‡∏á</option>
                                <option value="anime">‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞</option>
                            </select>
                            <div class="relative w-full sm:w-80">
                                <i class="fa-solid fa-magnifying-glass absolute left-4 top-3.5 text-slate-500"></i>
                                <input type="text" oninput="filterAdmin()" id="adminSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á..." class="w-full pl-12 pr-4 py-2.5 rounded-2xl outline-none">
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-900/50 text-[10px] text-slate-400 uppercase tracking-widest">
                                <tr>
                                    <th class="p-5">‡πÇ‡∏õ‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå</th>
                                    <th class="p-5">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡∏µ‡∏£‡∏µ‡∏™‡πå</th>
                                    <th class="p-5">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                                    <th class="p-5">‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á</th>
                                    <th class="p-5 text-right">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</th>
                                </tr>
                            </thead>
                            <tbody id="adminTableBody" class="divide-y divide-slate-800"></tbody>
                        </table>
                    </div>
                    <!-- Pagination Controls -->
                    <div class="p-6 border-t border-slate-800 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <span class="text-slate-400 text-sm" id="pageInfo">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                        <div class="flex gap-2">
                            <button onclick="changePage(-1)" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-xl text-white transition disabled:opacity-50" id="prevBtn"><i class="fa-solid fa-chevron-left"></i> ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
                            <button onclick="changePage(1)" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-xl text-white transition disabled:opacity-50" id="nextBtn">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <i class="fa-solid fa-chevron-right"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="usersSection" class="hidden section-animate">
                <div class="glass rounded-3xl overflow-hidden shadow-2xl">
                    <div class="p-6 border-b border-slate-800 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <h2 class="font-bold text-lg flex items-center gap-2"><i class="fa-solid fa-users text-sky-500"></i> ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
                        <div class="relative w-full sm:w-80">
                            <i class="fa-solid fa-magnifying-glass absolute left-4 top-3.5 text-slate-500"></i>
                            <input type="text" oninput="searchUsers()" id="userSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏µ‡πÄ‡∏°‡∏•..." class="w-full pl-12 pr-4 py-2.5 rounded-2xl outline-none">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-900/50 text-[10px] text-slate-400 uppercase tracking-widest">
                                <tr>
                                    <th class="p-5">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</th>
                                    <th class="p-5">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                                    <th class="p-5">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th class="p-5 text-right">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody" class="divide-y divide-slate-800"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="announcementSection" class="hidden section-animate">
                <div class="glass rounded-3xl overflow-hidden shadow-2xl max-w-3xl mx-auto">
                    <div class="p-6 border-b border-slate-800">
                        <h2 class="font-bold text-lg flex items-center gap-2"><i class="fa-solid fa-bullhorn text-sky-500"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö</h2>
                    </div>
                    <div class="p-8 space-y-6">
                        <div>
                            <label for="announcementText" class="text-[10px] uppercase font-bold text-slate-500 ml-1 block mb-2">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</label>
                            <textarea id="announcementText" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏£‡∏∞‡∏ö‡∏ö 14:00 - 15:00 ‡∏ô." class="w-full px-5 py-4 rounded-2xl text-sm outline-none"></textarea>
                        </div>
                        <div class="flex items-center justify-between bg-slate-900/50 p-4 rounded-2xl border border-slate-800">
                            <label for="announcementActive" class="font-bold text-white cursor-pointer">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡πâ</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="announcementActive" class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-sky-600"></div>
                            </label>
                        </div>
                        <button onclick="saveAnnouncement()" class="w-full py-4 bg-sky-600 hover:bg-sky-500 text-white font-bold rounded-2xl transition shadow-xl shadow-sky-900/30 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
                        </button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="movieModal" class="fixed inset-0 bg-black/95 hidden flex items-center justify-center p-4 z-[100] backdrop-blur-md overflow-y-auto">
        <div class="glass w-full max-w-4xl rounded-[3rem] p-10 my-auto relative shadow-2xl">
            <button onclick="closeModal()" class="absolute top-8 right-10 text-slate-500 hover:text-white text-4xl">&times;</button>
            <h3 class="text-3xl font-bold mb-10 flex items-center gap-3" id="modalTitle">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡∏µ‡∏£‡∏µ‡∏™‡πå</h3>
            
            <div class="mb-10 p-6 bg-sky-500/5 border border-sky-500/10 rounded-[2rem] flex flex-col md:flex-row gap-4 items-center">
                <div class="flex-1 w-full relative">
                    <i class="fa-brands fa-youtube absolute left-5 top-4.5 text-red-500 text-xl"></i>
                    <input type="text" id="aiUrl" placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå YouTube ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ AI ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥..." class="w-full pl-14 pr-5 py-4 rounded-2xl outline-none">
                </div>
                <button onclick="fetchAiData()" id="aiBtn" class="w-full md:w-auto bg-sky-600 hover:bg-sky-500 px-10 py-4 rounded-2xl font-bold transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-robot"></i> ‡∏î‡∏∂‡∏á‡∏î‡πâ‡∏ß‡∏¢ AI
                </button>
            </div>

            <form id="movieForm" class="grid grid-cols-1 md:grid-cols-3 gap-10">
                <input type="hidden" id="movieId">
                <div class="space-y-4">
                    <div class="aspect-[2/3] rounded-[2rem] bg-slate-950 border-2 border-dashed border-slate-800 overflow-hidden relative">
                        <img id="posterPreview" class="w-full h-full object-cover hidden">
                        <div id="posterPlaceholder" class="absolute inset-0 flex flex-col items-center justify-center text-slate-600 p-6">
                            <i class="fa-solid fa-image text-5xl mb-4"></i>
                            <p class="text-[10px] text-center uppercase tracking-tighter">‡πÉ‡∏™‡πà URL ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</p>
                        </div>
                        <div id="uploadLoading" class="absolute inset-0 flex flex-col items-center justify-center z-10 bg-black/90">
                            <div class="w-2/3 bg-slate-800 rounded-full h-2 mb-3 overflow-hidden">
                                <div id="uploadProgressBar" class="bg-sky-500 h-full transition-all duration-200" style="width: 0%"></div>
                            </div>
                            <p id="uploadProgressText" class="text-[10px] text-sky-400 font-bold tracking-widest">UPLOADING 0%</p>
                        </div>
                    </div>
                    <div class="flex flex-col gap-2">
                        <input type="file" id="posterFile" accept="image/*" class="hidden" onchange="handleFileUpload(this)">
                        <button type="button" onclick="document.getElementById('posterFile').click()" class="w-full py-2 bg-slate-800 hover:bg-slate-700 rounded-xl text-xs font-bold transition">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
                        <input type="text" id="posterUrl" oninput="updatePreview()" placeholder="‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏≤‡∏á Poster URL" class="w-full px-4 py-2.5 rounded-xl text-xs outline-none">
                    </div>
                </div>

                <div class="md:col-span-2 space-y-5">
                    <div class="grid grid-cols-2 gap-5">
                        <div class="col-span-2">
                            <label class="text-[10px] uppercase font-bold text-slate-500 ml-1 block">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
                            <input type="text" id="title" class="w-full px-4 py-3 rounded-2xl outline-none" required>
                        </div>
                        <div>
                            <label class="text-[10px] uppercase font-bold text-slate-500 ml-1 block">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                            <select id="category" class="w-full px-4 py-3 rounded-2xl outline-none">
                                <option value="china">‡∏ã‡∏µ‡∏£‡∏µ‡∏™‡πå‡∏à‡∏µ‡∏ô (China)</option>
                                <option value="inter">‡∏û‡∏≤‡∏Å‡∏¢‡πå‡πÑ‡∏ó‡∏¢ (Inter)</option>
                                <option value="anime">‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞ (Anime)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] uppercase font-bold text-slate-500 ml-1 block">YouTube ID</label>
                            <input type="text" id="ytId" class="w-full px-4 py-3 rounded-2xl outline-none text-sky-400" required>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <label class="flex-1 flex items-center gap-3 p-4 bg-yellow-500/5 border border-yellow-500/10 rounded-2xl cursor-pointer">
                            <input type="checkbox" id="isVip" class="w-6 h-6 accent-yellow-500">
                            <span class="text-yellow-500 font-bold uppercase tracking-widest text-xs">VIP Only</span>
                        </label>
                        <div class="w-24">
                            <label class="text-[10px] uppercase font-bold text-slate-500 ml-1 block">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</label>
                            <input type="number" step="0.1" id="rating" class="w-full px-4 py-3 rounded-2xl outline-none">
                        </div>
                        <div class="w-32">
                            <label class="text-[10px] uppercase font-bold text-slate-500 ml-1 block">‡∏¢‡∏≠‡∏î‡∏ß‡∏¥‡∏ß</label>
                            <input type="number" id="viewCount" class="w-full px-4 py-3 rounded-2xl outline-none">
                        </div>
                    </div>
                    <div class="flex justify-between items-end px-1">
                        <label class="text-[10px] uppercase font-bold text-slate-500">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠ & Tags</label>
                        <button type="button" id="copyTagsBtn" onclick="copyTags()" class="text-[10px] text-sky-400 hover:text-sky-300 flex items-center gap-1 transition bg-sky-500/10 px-2 py-1 rounded-lg border border-sky-500/20 transform active:scale-95">
                            <i class="fa-solid fa-copy"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Tags
                        </button>
                    </div>
                    <textarea id="description" rows="4" placeholder="‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠‡∏ã‡∏µ‡∏£‡∏µ‡∏™‡πå..." class="w-full px-5 py-4 rounded-3xl text-sm outline-none"></textarea>
                    <button type="submit" class="w-full py-5 bg-green-600 hover:bg-green-500 text-white font-bold rounded-3xl transition shadow-2xl">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Ñ‡∏•‡∏±‡∏á</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Batch Import Modal -->
    <div id="batchModal" class="fixed inset-0 bg-black/95 hidden flex items-center justify-center p-4 z-[100] backdrop-blur-md">
        <div class="glass w-full max-w-2xl rounded-[3rem] p-10 my-auto relative shadow-2xl">
            <button onclick="closeBatchModal()" class="absolute top-8 right-10 text-slate-500 hover:text-white text-4xl">&times;</button>
            <h3 class="text-3xl font-bold mb-6 flex items-center gap-3"><i class="fa-solid fa-layer-group text-purple-400"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°</h3>
            <p class="text-slate-400 text-sm mb-6">‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö JSON Array ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏ö)</p>
            <textarea id="batchJson" rows="10" class="w-full p-4 rounded-2xl text-sm font-mono" placeholder='[{"title": "‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà 1", "ytId": "abc"}, {"title": "‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà 2", "ytId": "def"}]'></textarea>
            <button onclick="handleBatchImport()" class="mt-6 w-full py-4 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-2xl transition">
                <i class="fa-solid fa-file-import"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤
            </button>
        </div>
    </div>


    <script>
        // 1. Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBuhTA1YwcsNyxR0NLYW6JrxUQ9U7vyVeo",
            authDomain: "classic-e8ab7.firebaseapp.com",
            projectId: "classic-e8ab7",
            storageBucket: "classic-e8ab7.firebasestorage.app",
            messagingSenderId: "596308927760",
            appId: "1:596308927760:web:63043fd2786459082cb195",
            measurementId: "G-RCDSPGQ5LE"
        };
        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
        const db = firebase.firestore();

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô AI ‡πÅ‡∏•‡∏∞ YouTube (‡πÅ‡∏à‡πà‡∏°‡πÜ)
        async function fetchAiData() {
            const aiUrl = document.getElementById('aiUrl').value;
            const aiBtn = document.getElementById('aiBtn');
            if (!aiUrl) return alert("‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö‡∏û‡∏µ‡πà‡∏î‡∏∏‡πà‡∏¢!");

            aiBtn.disabled = true;
            aiBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ‡∏£‡∏≠‡πÅ‡∏õ‡πä‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö...';

            try {
                // ‡∏î‡∏∂‡∏á ID ‡πÅ‡∏•‡∏∞ ‡∏£‡∏π‡∏õ‡∏õ‡∏Å
                const vId = extractVideoID(aiUrl);
                if (vId) {
                    document.getElementById('ytId').value = vId;
                    document.getElementById('posterUrl').value = `https://img.youtube.com/vi/${vId}/maxresdefault.jpg`;
                    updatePreview();
                }

                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å AI Port 4000
                const res = await fetch('/api/ai/generate-summary', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: aiUrl })
                });
                const data = await res.json();
                
                if (data.summary) {
                    // ‡∏£‡∏ß‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠‡πÅ‡∏•‡∏∞ Tags ‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô
                    const fullDesc = data.summary + (data.tags ? `\n\n${data.tags}` : "");
                    document.getElementById('description').value = fullDesc;
                }
                if (data.category) {
                    document.getElementById('category').value = data.category;
                }
                if (data.rating) {
                    document.getElementById('rating').value = data.rating;
                }
                
                alert("‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            } catch (err) {
                alert("‚ùå ‡∏•‡∏∑‡∏°‡πÄ‡∏õ‡∏¥‡∏î Backend Port 4000 ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö?");
            } finally {
                aiBtn.disabled = false;
                aiBtn.innerHTML = '<i class="fa-solid fa-robot"></i> ‡∏î‡∏∂‡∏á‡∏î‡πâ‡∏ß‡∏¢ AI';
            }
        }

        function copyTags() {
            const desc = document.getElementById('description').value;
            // ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ #
            const tags = desc.match(/#[\w\u0E00-\u0E7F]+/g);
            const btn = document.getElementById('copyTagsBtn');
            
            if (tags) {
                navigator.clipboard.writeText(tags.join(' '));
                
                // Animation Effect
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-check"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!';
                btn.className = "text-[10px] text-green-400 flex items-center gap-1 transition bg-green-500/10 px-2 py-1 rounded-lg border border-green-500/20 transform scale-105";
                
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.className = "text-[10px] text-sky-400 hover:text-sky-300 flex items-center gap-1 transition bg-sky-500/10 px-2 py-1 rounded-lg border border-sky-500/20 transform active:scale-95";
                }, 1500);
            } else {
                alert("‡πÑ‡∏°‡πà‡∏û‡∏ö Tags ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠");
            }
        }

        function extractVideoID(url) {
            const reg = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
            const m = url.match(reg);
            return (m && m[7].length == 11) ? m[7] : false;
        }

        function updatePreview() {
            const url = document.getElementById('posterUrl').value;
            const img = document.getElementById('posterPreview');
            const placeholder = document.getElementById('posterPlaceholder');
            if (url) {
                img.src = url;
                img.classList.remove('hidden');
                img.classList.add('glow-sky');
                placeholder.classList.add('hidden');
            } else {
                img.classList.add('hidden');
                placeholder.classList.remove('hidden');
            }
        }

        // 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡∏µ‡∏£‡∏µ‡∏™‡πå
        let allMovies = []; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏±‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        let filteredMovies = []; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏ö‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤
        let currentPage = 1;
        const rowsPerPage = 10;
        let myChart = null;

        async function loadAdminData() {
            const snap = await db.collection('movies').orderBy('createdAt', 'desc').get();
            allMovies = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            
            filterAdmin(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ó‡∏ô

            document.getElementById('statTotal').innerText = allMovies.length;
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ VIP
            const vipCount = allMovies.filter(m => m.isVip).length;
            document.getElementById('statVip').innerText = vipCount;

            renderAdminTable();
            renderChart();
        }

        function renderAdminTable() {
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const displayMovies = filteredMovies.slice(start, end);

            document.getElementById('adminTableBody').innerHTML = displayMovies.map(m => `
                <tr class="hover:bg-slate-900/30 transition">
                    <td class="p-5"><img src="${m.posterUrl}" class="w-12 h-16 object-cover rounded-lg"></td>
                    <td class="p-5"><div class="font-bold text-white">${m.title}</div></td>
                    <td class="p-5"><span class="px-2 py-1 bg-slate-800 text-xs">${m.category}</span></td>
                    <td class="p-5">${m.isVip ? 'üëë VIP' : 'Free'}</td>
                    <td class="p-5 text-right">
                        <button onclick="editMovie('${m.id}')" class="text-amber-400 hover:text-amber-300 mr-3 transition"><i class="fa-solid fa-pen-to-square"></i></button>
                        <button onclick="deleteMovie('${m.id}')" class="text-red-500 hover:text-red-400 transition"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Pagination
            const totalPages = Math.ceil(filteredMovies.length / rowsPerPage) || 1;
            document.getElementById('pageInfo').innerText = `‡πÅ‡∏™‡∏î‡∏á ${filteredMovies.length > 0 ? start + 1 : 0}-${Math.min(end, filteredMovies.length)} ‡∏à‡∏≤‡∏Å ${filteredMovies.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏´‡∏ô‡πâ‡∏≤ ${currentPage}/${totalPages})`;
            
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
        }

        function changePage(direction) {
            const totalPages = Math.ceil(filteredMovies.length / rowsPerPage);
            const newPage = currentPage + direction;
            if (newPage > 0 && newPage <= totalPages) {
                currentPage = newPage;
                renderAdminTable();
            }
        }

        function filterAdmin() {
            const query = document.getElementById('adminSearch').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;

            filteredMovies = allMovies.filter(m => {
                const matchesSearch = m.title.toLowerCase().includes(query);
                const matchesCategory = category === 'all' || m.category === category;
                return matchesSearch && matchesCategory;
            });

            currentPage = 1;
            renderAdminTable();
        }

        function renderChart() {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏ß‡∏¥‡∏ß (View Count) ‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢ ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏°‡∏≤‡πÅ‡∏Ñ‡πà 10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å
            const topMovies = [...allMovies]
                .sort((a, b) => (b.viewCount || 0) - (a.viewCount || 0))
                .slice(0, 10);

            const labels = topMovies.map(m => m.title);
            const data = topMovies.map(m => m.viewCount || 0);

            if (myChart) myChart.destroy(); // ‡∏•‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '‡∏¢‡∏≠‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ä‡∏° (‡∏Ñ‡∏£‡∏±‡πâ‡∏á)',
                        data: data,
                        backgroundColor: '#0ea5e9',
                        borderRadius: 6,
                        barThickness: 20
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y', // ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { 
                            grid: { color: '#1e293b' },
                            ticks: { color: '#94a3b8' }
                        },
                        y: { 
                            grid: { display: false },
                            ticks: { color: '#e2e8f0', font: { family: 'Kanit' } }
                        }
                    }
                }
            });
        }

        // 4. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Users
        let allUsers = [];

        async function loadUsers() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '<tr><td colspan="4" class="p-5 text-center text-slate-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';

            try {
                const snap = await db.collection('users').get();
                allUsers = snap.docs.map(d => ({ uid: d.id, ...d.data() }));
                renderUsers(allUsers);
            } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="4" class="p-5 text-center text-red-400">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏≠‡∏≤‡∏à‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Collection users)</td></tr>';
            }
        }

        function renderUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-5 text-center text-slate-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(u => `
                <tr class="hover:bg-slate-900/30 transition">
                    <td class="p-5 flex items-center gap-3">
                        <img src="${u.photoUrl || 'https://ui-avatars.com/api/?name='+(u.username||'User')}" class="w-10 h-10 rounded-full bg-slate-800 object-cover">
                        <span class="font-bold text-white">${u.username || 'Unknown'}</span>
                    </td>
                    <td class="p-5 text-slate-400 text-sm">${u.email || '-'}</td>
                    <td class="p-5">
                        ${u.isVip 
                            ? '<span class="bg-yellow-500/10 text-yellow-400 px-3 py-1 rounded-full text-xs font-bold border border-yellow-500/20">üëë VIP MEMBER</span>' 
                            : '<span class="bg-slate-800 text-slate-400 px-3 py-1 rounded-full text-xs font-bold">FREE USER</span>'}
                    </td>
                    <td class="p-5 text-right">
                        <button onclick="toggleVip('${u.uid}', ${u.isVip || false})" class="px-4 py-2 rounded-xl text-xs font-bold transition ${u.isVip ? 'bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white' : 'bg-green-500/10 text-green-400 hover:bg-green-500 hover:text-white'}">
                            ${u.isVip ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å VIP' : '‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô VIP'}
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function toggleVip(uid, currentStatus) {
            if(!confirm(currentStatus ? '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ VIP?' : '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô VIP?')) return;
            try {
                // ‡πÉ‡∏ä‡πâ set merge ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
                await db.collection('users').doc(uid).set({ isVip: !currentStatus }, { merge: true });
                loadUsers(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
            } catch (e) { alert('Error: ' + e.message); }
        }

        function searchUsers() {
            const query = document.getElementById('userSearch').value.toLowerCase();
            const filtered = allUsers.filter(u => 
                (u.username && u.username.toLowerCase().includes(query)) || 
                (u.email && u.email.toLowerCase().includes(query))
            );
            renderUsers(filtered);
        }

        // 5. Announcement Management
        async function loadAnnouncement() {
            try {
                const doc = await db.collection('announcements').doc('main').get();
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('announcementText').value = data.text || '';
                    document.getElementById('announcementActive').checked = data.isActive || false;
                } else {
                    console.log("No announcement document found. A new one will be created on save.");
                }
            } catch (e) {
                console.error("Error loading announcement:", e);
                alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏î‡πâ");
            }
        }

        async function saveAnnouncement() {
            const text = document.getElementById('announcementText').value;
            const isActive = document.getElementById('announcementActive').checked;

            try {
                await db.collection('announcements').doc('main').set({
                    text: text,
                    isActive: isActive,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
            } catch (e) {
                console.error("Error saving announcement:", e);
                alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: " + e.message);
            }
        }

        // 6. Navigation System
        function showSection(sectionId) {
            // Hide all
            ['movies', 'users', 'announcement'].forEach(id => {
                document.getElementById(id + 'Section').classList.add('hidden');
                document.getElementById('nav-' + id).classList.remove('active-nav');
                document.getElementById('nav-' + id).classList.add('text-slate-400', 'hover:bg-slate-900');
            });

            // Show selected
            document.getElementById(sectionId + 'Section').classList.remove('hidden');
            const navBtn = document.getElementById('nav-' + sectionId);
            navBtn.classList.add('active-nav');
            navBtn.classList.remove('text-slate-400', 'hover:bg-slate-900');

            if (sectionId === 'users') loadUsers();
            if (sectionId === 'announcement') loadAnnouncement();
        }

        // 7. Form Handling (Add/Edit/Delete)
        function openAddModal() {
            document.getElementById('movieForm').reset();
            document.getElementById('movieId').value = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå ID ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
            document.getElementById('posterPreview').classList.add('hidden');
            document.getElementById('posterPlaceholder').classList.remove('hidden');
            document.getElementById('viewCount').value = 0;
            document.getElementById('modalTitle').innerText = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ã‡∏µ‡∏£‡∏µ‡∏™‡πå‡πÉ‡∏´‡∏°‡πà";
            openModal();
        }

        function editMovie(id) {
            const movie = allMovies.find(m => m.id === id);
            if (!movie) return;

            // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
            document.getElementById('movieId').value = movie.id;
            document.getElementById('title').value = movie.title;
            document.getElementById('category').value = movie.category;
            document.getElementById('ytId').value = movie.ytId;
            document.getElementById('rating').value = movie.rating;
            document.getElementById('description').value = movie.description;
            document.getElementById('posterUrl').value = movie.posterUrl;
            document.getElementById('viewCount').value = movie.viewCount || 0;
            document.getElementById('isVip').checked = movie.isVip;

            updatePreview(); // ‡πÇ‡∏ä‡∏ß‡πå‡∏£‡∏π‡∏õ‡∏õ‡∏Å
            document.getElementById('modalTitle').innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡∏µ‡∏£‡∏µ‡∏™‡πå";
            openModal();
        }

        async function deleteMovie(id) {
            if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ?')) return;
            try {
                await db.collection('movies').doc(id).delete();
                loadAdminData();
            } catch (e) { alert(e.message); }
        }

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏° (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
        document.getElementById('movieForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('movieId').value;
            
            // üõ°Ô∏è ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå YouTube ‡∏û‡∏±‡∏á: ‡∏ï‡∏±‡∏î‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ID ‡πÄ‡∏™‡∏°‡∏≠
            let rawYtId = document.getElementById('ytId').value.trim();
            // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 11 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ ‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô URL ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏™‡∏Å‡∏±‡∏î ID
            if (rawYtId.length > 11) {
                const extracted = extractVideoID(rawYtId);
                if (extracted) rawYtId = extracted;
            }
            // (‡∏ñ‡πâ‡∏≤‡∏™‡∏±‡πâ‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 11 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô ID ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)

            const data = {
                title: document.getElementById('title').value,
                category: document.getElementById('category').value,
                ytId: rawYtId, // ‡πÉ‡∏ä‡πâ ID ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
                rating: parseFloat(document.getElementById('rating').value) || 0,
                viewCount: parseInt(document.getElementById('viewCount').value) || 0,
                description: document.getElementById('description').value,
                posterUrl: document.getElementById('posterUrl').value,
                isVip: document.getElementById('isVip').checked,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if (id) {
                    // ‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Update)
                    await db.collection('movies').doc(id).update(data);
                    alert('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
                } else {
                    // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà (Create)
                    data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('movies').add(data);
                    alert('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
                }
                closeModal();
                loadAdminData();
            } catch (error) {
                console.error(error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        });

        // 8. Backup & Restore / Batch
        function openBatchModal() {
            document.getElementById('batchJson').value = '';
            document.getElementById('batchModal').classList.remove('hidden');
        }

        function closeBatchModal() {
            document.getElementById('batchModal').classList.add('hidden');
        }

        async function handleBatchImport() {
            const jsonText = document.getElementById('batchJson').value;
            if (!jsonText) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSON ‡∏Å‡πà‡∏≠‡∏ô');

            try {
                const moviesToImport = JSON.parse(jsonText);
                if (!Array.isArray(moviesToImport)) {
                    return alert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Array ‡∏Ç‡∏≠‡∏á Object ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                }

                if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${moviesToImport.length} ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏ö)`)) return;

                const batch = db.batch();
                moviesToImport.forEach(movie => {
                    const docRef = db.collection('movies').doc(); // ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                    const data = {
                        title: movie.title || 'No Title',
                        category: movie.category || 'inter',
                        ytId: movie.ytId || '',
                        rating: parseFloat(movie.rating) || 0,
                        viewCount: parseInt(movie.viewCount) || 0,
                        description: movie.description || '',
                        posterUrl: movie.posterUrl || '',
                        isVip: movie.isVip || false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    batch.set(docRef, data);
                });

                await batch.commit();
                alert(`‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${moviesToImport.length} ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
                closeBatchModal();
                loadAdminData();

            } catch (e) {
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤: ' + e.message);
                console.error(e);
            }
        }

        async function backupDatabase() {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏±‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Movies Collection) ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

            try {
                const snap = await db.collection('movies').orderBy('createdAt', 'desc').get();
                const moviesData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // ‡πÅ‡∏õ‡∏•‡∏á Timestamp ‡πÄ‡∏õ‡πá‡∏ô ISO String ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏ü‡∏•‡πå JSON ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
                const moviesForJson = moviesData.map(movie => {
                    const newMov = { ...movie };
                    if (newMov.createdAt && newMov.createdAt.toDate) newMov.createdAt = newMov.createdAt.toDate().toISOString();
                    if (newMov.updatedAt && newMov.updatedAt.toDate) newMov.updatedAt = newMov.updatedAt.toDate().toISOString();
                    return newMov;
                });

                const jsonString = JSON.stringify(moviesForJson, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const date = new Date().toISOString().slice(0, 10);
                a.href = url;
                a.download = `duydodee-movies-backup-${date}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (e) {
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + e.message);
                console.error(e);
            }
        }

        document.getElementById('restoreFile').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirm('‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏à‡∏∞ "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö" ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ ID ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå. ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠?')) {
                event.target.value = ''; return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const moviesToRestore = JSON.parse(e.target.result);
                    if (!Array.isArray(moviesToRestore)) return alert('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Array');
                    
                    const batch = db.batch();
                    moviesToRestore.forEach(movie => {
                        if (!movie.id) return;
                        const docRef = db.collection('movies').doc(movie.id);
                        const dataToSet = { ...movie };
                        delete dataToSet.id;
                        if (dataToSet.createdAt && typeof dataToSet.createdAt === 'string') dataToSet.createdAt = firebase.firestore.Timestamp.fromDate(new Date(dataToSet.createdAt));
                        if (dataToSet.updatedAt && typeof dataToSet.updatedAt === 'string') dataToSet.updatedAt = firebase.firestore.Timestamp.fromDate(new Date(dataToSet.updatedAt));
                        batch.set(docRef, dataToSet);
                    });

                    await batch.commit();
                    alert(`‚úÖ ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${moviesToRestore.length} ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
                    loadAdminData();
                } catch (err) {
                    alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå JSON: ' + err.message);
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        });

        window.onload = loadAdminData;
        function openModal() { document.getElementById('movieModal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('movieModal').classList.add('hidden'); }
        function closeBatchModal() { document.getElementById('batchModal').classList.add('hidden'); }
    </script>
</body>
</html>