<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - DUYDOO DEE</title>
    <!-- ‡πÉ‡∏ä‡πâ Tailwind CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ‡πÉ‡∏ä‡πâ Axios ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏¥‡∏á API -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- ‡πÉ‡∏ä‡πâ SweetAlert2 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ß‡∏¢‡πÜ -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

    <!-- Navbar -->
    <nav class="bg-gray-800 p-4 shadow-lg border-b border-gray-700">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-yellow-500 flex items-center gap-2">
                üé¨ DUYDOO ADMIN
            </h1>
            <button onclick="logout()" class="text-gray-300 hover:text-white bg-gray-700 px-4 py-2 rounded transition">
                ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
            </button>
        </div>
    </nav>

    <div class="container mx-auto p-4 md:p-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á (‡∏ã‡πâ‡∏≤‡∏¢‡∏°‡∏∑‡∏≠) -->
            <div class="lg:col-span-1">
                <div class="bg-gray-800 p-6 rounded-xl shadow-xl border border-gray-700 sticky top-8">
                    <h2 class="text-xl font-semibold mb-4 text-yellow-400 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á‡πÉ‡∏´‡∏°‡πà
                    </h2>

                    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• AI -->
                    <div class="mb-6 bg-gray-700/50 p-4 rounded-lg border border-gray-600">
                        <label class="block text-sm text-gray-300 mb-2">1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å YouTube</label>
                        <div class="flex gap-2">
                            <input type="text" id="ytInput" class="w-full p-2 rounded bg-gray-700 border border-gray-500 text-sm focus:border-yellow-500 outline-none transition text-white" placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå YouTube ‡∏´‡∏£‡∏∑‡∏≠ ID ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà">
                            <button onclick="fetchMovieData()" class="bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded text-white text-sm transition shadow-lg whitespace-nowrap">
                                ‚ú® ‡πÉ‡∏´‡πâ AI ‡∏ä‡πà‡∏ß‡∏¢
                            </button>
                        </div>
                    </div>

                    <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
                    <form id="addMovieForm" onsubmit="submitMovie(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á</label>
                            <input type="text" id="title" required class="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:border-yellow-500 outline-none transition">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏â‡∏≤‡∏¢</label>
                                <input type="number" id="year" required class="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:border-yellow-500 outline-none transition">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (0-10)</label>
                                <input type="number" step="0.1" id="rating" required class="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:border-yellow-500 outline-none transition">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm text-gray-400 mb-1">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                            <select id="category" class="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:border-yellow-500 outline-none transition text-white">
                                <option value="china">‡∏à‡∏µ‡∏ô</option>
                                <option value="korea">‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ</option>
                                <option value="western">‡∏ù‡∏£‡∏±‡πà‡∏á</option>
                                <option value="thai">‡πÑ‡∏ó‡∏¢</option>
                                <option value="anime">‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm text-gray-400 mb-1">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠</label>
                            <textarea id="description" rows="4" class="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:border-yellow-500 outline-none transition text-sm"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm text-gray-400 mb-1">‡∏ô‡∏±‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏ô‡∏≥</label>
                            <input type="text" id="actors" class="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:border-yellow-500 outline-none transition text-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏£‡∏∞‡πÄ‡∏≠‡∏Å, ‡∏ô‡∏≤‡∏á‡πÄ‡∏≠‡∏Å">
                        </div>

                        <div>
                            <label class="block text-sm text-gray-400 mb-1">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
                            <textarea id="lessons" rows="2" class="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:border-yellow-500 outline-none transition text-sm" placeholder="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏¥‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ..."></textarea>
                        </div>

                        <!-- Hidden Fields & Preview -->
                        <input type="hidden" id="posterUrl">
                        <input type="hidden" id="ytId">
                        
                        <div id="previewArea" class="hidden text-center bg-black/30 p-4 rounded-lg border border-gray-700">
                            <p class="text-xs text-gray-500 mb-2">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏Å</p>
                            <img id="posterPreview" src="" class="mx-auto rounded shadow-lg max-h-40 object-cover">
                        </div>

                        <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 rounded-lg shadow-lg shadow-yellow-500/20 transition transform hover:scale-[1.02]">
                            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>
                    </form>
                </div>
            </div>

            <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á (‡∏Ç‡∏ß‡∏≤‡∏°‡∏∑‡∏≠) -->
            <div class="lg:col-span-2">
                <div class="bg-gray-800 p-6 rounded-xl shadow-xl border border-gray-700">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-white">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
                        <button onclick="loadMovies()" class="text-sm text-blue-400 hover:text-blue-300 flex items-center gap-1">
                            üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-gray-400">
                            <thead class="bg-gray-700 text-gray-200 uppercase text-xs">
                                <tr>
                                    <th class="p-3 rounded-tl-lg">‡∏õ‡∏Å</th>
                                    <th class="p-3">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
                                    <th class="p-3">‡∏õ‡∏µ</th>
                                    <th class="p-3">‡∏´‡∏°‡∏ß‡∏î</th>
                                    <th class="p-3 rounded-tr-lg text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="movieTableBody" class="text-sm divide-y divide-gray-700">
                                <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000/api';
        
        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Check Auth)
        const token = localStorage.getItem('accessToken');
        if (!token) {
            window.location.href = 'login.html'; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Token ‡∏î‡∏µ‡∏î‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login
        }

        function logout() {
            localStorage.removeItem('accessToken');
            window.location.href = 'login.html';
        }

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å AI
        async function fetchMovieData() {
            const input = document.getElementById('ytInput').value;
            if (!input) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå YouTube ‡∏´‡∏£‡∏∑‡∏≠ ID', 'warning');

            // ‡πÅ‡∏õ‡∏•‡∏á URL ‡πÄ‡∏õ‡πá‡∏ô Video ID
            let videoId = input;
            try {
                if (input.includes('youtube.com') || input.includes('youtu.be')) {
                    const url = new URL(input);
                    if (url.hostname.includes('youtu.be')) videoId = url.pathname.slice(1);
                    else videoId = url.searchParams.get('v');
                }
            } catch (e) {}

            // ‡πÅ‡∏™‡∏î‡∏á Loading
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', text: '‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô', didOpen: () => Swal.showLoading() });

            try {
                const res = await axios.post(`${API_URL}/fetch-movie-data`, { videoId }, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                if (res.data.success) {
                    const d = res.data.data;
                    // ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                    document.getElementById('title').value = d.title;
                    document.getElementById('year').value = d.year;
                    document.getElementById('rating').value = d.rating;
                    document.getElementById('description').value = d.description;
                    document.getElementById('actors').value = d.actors || ''; // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å AI
                    document.getElementById('lessons').value = d.lessons || ''; // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏¥‡∏î‡∏à‡∏≤‡∏Å AI
                    document.getElementById('posterUrl').value = d.posterUrl;
                    document.getElementById('ytId').value = d.ytId;
                    
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                    document.getElementById('posterPreview').src = d.posterUrl;
                    document.getElementById('previewArea').classList.remove('hidden');
                    Swal.close();
                }
            } catch (err) {
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.response?.data?.message || err.message, 'error');
            }
        }

        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏ô‡∏±‡∏á (Submit)
        async function submitMovie(e) {
            e.preventDefault();
            const data = {
                title: document.getElementById('title').value,
                year: document.getElementById('year').value,
                rating: document.getElementById('rating').value,
                description: document.getElementById('description').value,
                actors: document.getElementById('actors').value, // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                lessons: document.getElementById('lessons').value, // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏¥‡∏î‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                category: document.getElementById('category').value,
                posterUrl: document.getElementById('posterUrl').value,
                ytId: document.getElementById('ytId').value
            };

            try {
                await axios.post(`${API_URL}/movies`, data, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                
                // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°
                document.getElementById('addMovieForm').reset();
                document.getElementById('ytInput').value = '';
                document.getElementById('previewArea').classList.add('hidden');
                loadMovies(); // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
            } catch (err) {
                Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', err.response?.data?.message || err.message, 'error');
            }
        }

        // 4. ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á (Load List)
        async function loadMovies() {
            try {
                const res = await axios.get(`${API_URL}/movies`);
                const tbody = document.getElementById('movieTableBody');
                tbody.innerHTML = res.data.data.map(m => `
                    <tr class="hover:bg-gray-700/50 transition border-b border-gray-700 last:border-0">
                        <td class="p-3"><img src="${m.posterUrl}" class="w-10 h-14 object-cover rounded shadow-sm"></td>
                        <td class="p-3 font-medium text-white">${m.title}</td>
                        <td class="p-3 text-gray-400">${m.year}</td>
                        <td class="p-3"><span class="bg-gray-700 px-2 py-1 rounded text-xs text-yellow-400 border border-gray-600">${m.category}</span></td>
                        <td class="p-3 text-center">
                            <button onclick="deleteMovie('${m._id}')" class="text-red-400 hover:text-red-300 hover:bg-red-400/10 p-2 rounded transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error(err);
            }
        }

        // 5. ‡∏•‡∏ö‡∏´‡∏ô‡∏±‡∏á
        async function deleteMovie(id) {
            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?',
                text: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ñ‡∏≤‡∏ß‡∏£‡∏ô‡∏∞!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: '‡∏•‡∏ö‡πÄ‡∏•‡∏¢!',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });

            if (result.isConfirmed) {
                try {
                    await axios.delete(`${API_URL}/movies/${id}`, {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    Swal.fire('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß!', '‡πÑ‡∏ü‡∏•‡πå‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                    loadMovies();
                } catch (err) {
                    Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ', 'error');
                }
            }
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        loadMovies();
    </script>
</body>
</html>